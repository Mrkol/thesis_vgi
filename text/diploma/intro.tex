
\section{Введение}
\label{sec:intro}
С самого зарождения области интерактивной компьютерной 3D графики люди стремились повысить количество примитивов одновременно отображаемых на экране. Это один из самых естественных способов повысить общее качество изображения. Однако, не смотря на стремительное развитие графических ускорителей, наивный подход не даёт удовлетворительных результатов: в современных приложениях реального времени бюджет количества треугольников на экране остаётся достаточно ограниченным. С другой стороны современные программы для скульптурирования, а также различные технологии 3D сканирования, позволяют получить модели, количество полигонов которых почти не ограничено. Бюджет приложения может быть насыщен всего лишь одним сканом в высоком качестве.

Исторически для решения этой проблемы было придумано множество техник экономии количества треугольников без потери визуального качества. Самым частым подходом является использование так называемых \emph{уровней детализации} совместно с различными картами. Уровень детализации -- результат геометрического упрощения исходной модели содержащий меньше полигонов. Как правило генерируется несколько различных уровней детализации для модели с числом треугольников отличающимся на порядок, а затем при рендеринге динамически выбирается одна из них в зависимости от расстояния до наблюдателя. Различные карты используются чтобы восстановить визуальное качество модели потерянное за счёт упрощения. Среди часто используемых карт -- normal mapping \cite{normalmapping}, различные формы displacement mapping \cite{reliefmapping}, \cite{displacementmapping}. Это семейство подходов основано на одном простом наблюдении: чем меньше видимый размер объекта на экране, тем меньше экранных пикселей он занимает, а следовательно тем менее заметны высокочастотные детали модели. Однако наивное использование уровней детализации сталкивается с множеством проблем. В случае если целевая модель много больше размера наблюдателя (например ландшафт), не редка ситуация когда наблюдатель всегда находится вблизи какой-то из частей модели, а следовательно необходимо всегда отображать всю модель в максимальном качестве. В литературе задачу решения этой проблемы называют \emph{задачей адаптивного рендеринга}. Ещё одной проблемой является потребление видеопамяти. Если просто загружать все уровни детализации всех моделей сцены в видеопамять, она достаточно быстро израсходуется. Существует множество техник решающих эту проблему. Стандартным подходом является комбинирование раннего отбрасывания моделей с графического конвейера (\cite{frustum_culling}, \cite{coorg1997real}) в сочетании с уровнями детализации и асинхронной загрузкой данных в видеопамять. Заметим, что подобные подходы не применимы к крупным объектам по аналогичным причинам: объекты рассматриваются как неделимое целое.

Виртуализация геометрии -- один из подходов к решению задачи адаптивного рендеринга. Предлагается хранить в видеопамяти только те части модели, которые необходимо отображать в данный момент, при этом только в том качестве, в котором необходимо. В случае если необходимого качества в данный момент нет, вполне допустимо использовать геометрию в более низком качестве. Таким образом с точки зрения итогового изображения создаётся видимость что вся модель всегда доступна в максимальном разрешении, откуда название по аналогии с технологией виртуальной памяти используемой в операционных системах. Вариаций в реализации этой идеи достаточно много. В данной работе за основу взята статья \cite{niski2007multi}. Причиной этому послужил анонс ``Unreal Engine 5'' \cite{ue5} летом 2020 года. Было выяснено, что реализованная в нём технология микрополигонального рендеринга ``Nanite'' тоже берёт своё начало в упомянутой выше статье (согласно \cite{graphicrants_vgi}, блогу одного из разработчиков Nanite). Целью данной работы положим современную эффективную имплементацию идей этой статьи, а также исследование деталей реализации опущенных в оригинальной статье.


\subsection{Формальная постановка задачи}
Введём несколько определений используемых в данной работе.
\begin{itemize}
\item Мешем из $n$ вершин называют пару $M = (I, A)$, числа $1,...,n$ называют вершинами, $I \subset \{1, ..., n\}^3$ -- индексное множество задающее треугольники (тройки вершин), а $A: \{1, ..., n\} \rightarrow \mathbb{R}^3 \times \mathbb{R}^n$ -- атрибуты вершин, первые 3 компоненты которых считаются координатами в трёхмерном евклидовом пространстве. Меш индуцирует подмножество евклидового пространства как объединение выпуклых оболочек координат треугольников. Ради простоты отождествим треугольник как тройку индексов и выпуклую оболочку его координат, а также меш и индуцированное им множество. Остальные атрибуты меша продолжаются с вершин треугольника на все его точки посредством барицентрической интерполяции. Систему отсчёта в которой заданы координаты вершин меша называют системой отсчёта модели. В данной работе в качестве вершинных атрибутов взяты помимо координат направления нормалей в системе отсчёта модели, сдвинутой в соответствующую точку поверхности, а также координаты параметризации меша, иначе говоря UV-развёртки.
\item Дискретным многообразием (с краем) назовём меш, задающий подмножество евклидова пространства, являющееся многообразием (с краем).
\item Картой набора треугольников дискретного многообразия образующих замкнутое связное множество назовём гомеоморфизм его с $[0,1]^2$ (далее -- параметрическое пространство), однозначно задаваемый его значениями в вершинах соответствующих треугольников. Дополнительно потребуем чтобы углы параметрического пространства переходили в вершины меша, а рёбра в наборы рёбер. Таким образом область определения карты задаёт четырёхугольник на поверхности меша.
\item Набор карт, области определения которых полностью покрывают всё дискретное многообразие, назовём непрерывным атласом, если любые две области определения пересекаются либо по общему ребру этих четырёхугольников, либо по общей вершине, а также значения гомеоморфизмов разных карт согласованы на точках пересечения их областей определения. Это позволяет определить понятие соседей для карты атласа -- карт, граничащих с ней с четырёх сторон её области определения.
\item Геометрическим изображением назовём матрицу, элементами которой являются некоторые элементы $\mathbb{R}^3\times \mathbb{R}^n$. Геометрическое изображение задаёт дискретное многообразие (или его часть) посредством отождествления атрибутов вершин и элементов матрицы и взятием множества треугольников как триангуляции прямоугольной решётки.
\item Иерархическим атласом \cite{niski2007multi} дискретного многообразия называют лес квадродеревьев, с каждой вершиной которого связана карта. При этом карты корней деревьев должны образовывать непрерывный атлас, а дети каждой вершины обязаны разбивать родительскую карту на 4 равных квадрата в параметрическом пространстве.
\item Разрезом иерархического атласа называют минимальное \emph{по включению} подмножество вершин леса такое, что любой путь из корня дерева в лист проходит по вершине этого множества. Заметим, что подмножество вершин удовлетворяет этому определению тогда и только тогда, когда объединение карт вершин этого подмножества покрывает всё многообразие без наложений.
\end{itemize}

Задача виртуализации состоит из следующих подзадач: построение непрерывного атласа по имеющемуся дискретному многообразию, построение геометрических изображений для каждой карты атласа, построение мип-уровней геометрических изображений, построение иерархического атласа, адаптация разреза, рендеринг. При этом в результате рендеринга разреза иерархического атласа изображение должно как можно меньше отличаться от изображения исходного многообразия.

\subsection{Обзор литературы}
\label{sec:related}
Рассмотрим несколько перспективных подходов к адаптивному рендерингу и сравним их с выбранным в этой работе.

\subsubsection{Subdivision surfaces with displacement maps}
Subdivision surfaces with displacement maps (далее SSDM, \cite{ssdm}) -- достаточно популярная в областях анимации и визуальных эффектов технология. Основная идея subdivision surfaces заключается в задании модели неявным образом как интерполяции набора хранимых явно узлов и рёбер, определяющих топологию поверхности (дальше -- каркас). При повторной дискретизации интерполированной поверхности появляется возможность выбрать частоту соответствующую плотности экранных пикселей на поверхности для текущего положения камеры. Сама интерполяция происходит на GPU при помощи тесселяционных шейдеров, что позволяет ограничится передачей в графическую память лишь каркаса. Название displacement mapping же говорит само за себя, каждой точке поверхности сопоставляется вектор-смещение, которые дискретизирются при помощи традиционных текстур. Использование этих идей вместе позволяет добится динамической смены уровня детализации на близких расстояниях без потери качества картинки, при этом качество ограничено исключительно разрешением используемых текстур. Более того, SSDM полностью анимируемы. Основные проблемы же этой техники начинается на средних и дальних дистанциях отрисовки, ведь наиболее разреженной интерполяцией будет служить сам каркас. При рендеринге объектов со сложной топологией необходимо задать эту топологию на уровне каркаса, что может заметно его измельчить. Также к измельчению приводит поддержка скелетных анимаций, так как привязывать к скелету можно только узлы каркаса, а не индивидуальные точки поверхности. В своей статье \cite{graphicrants_moregeometry} Брайан Карис, один разработчиков Nanite, приводит как пример модели персонажей в одном из его проектов для которых каркас пришлось сделать настолько измельчённым, что он фактически совпадал с традиционной моделью персонажа на близком уровне детализации. Ещё одним значительным недостатком является специфичность формата используемого этой техникой. Универсального алгоритма конвертации в этот формат нет, и скорее всего никогда не появится, ведь форму и плотность каркаса нужно выбирать учитывая большое количество факторов, в том числе визуальное качество результата, поэтому модели приходится делать изначально в ПО поддерживающем этот формат. Также это ограничивает возможность применения SSDM к 3D-сканам различных объектов и ландшафтов. Дальнейшее ознакомление с SSDM можно начать с \cite{ref}.

\subsubsection{Воксельный рейкастинг}
Воксельный рейкастинг \cite{cur_and_next_parallelism} -- техника, заключается в редискретизации статической геометрии по трёхмерной сетке, хранении результата в разреженном октодереве и последующем рендеринге при помощи рейкастинга из каждого экранного пикселя. Также в процессе рендеринга используется трёхмерное виртуальное текстурирование. В отличии от SSDM воксельный рейкастинг не накладывает никаких ограничений на используемые модели и форматы. Производительность не зависит от свойств модели. С помощью вокселей можно хранить любые свойства поверхности и форму геометрии в однородном виде, что упрощает весь пайплайн. Также к трёхмерным текстурам можно применять традиционные алгоритмы компрессии из обработки изображений. Ну и наконец как и SSDM эта техника позволяет выбирать частоту дискретизации основываясь на плотности пикселей, что приводит к хорошему качеству картинки на всех уровнях детализации с приемлемой производительностью. Из явных недостатков же следует упомянуть дороговизну рейкастинга с точки зрения производительности. Также заметим требовательность техники к видеопамяти и необходимость дополнительных надстроек для её экономии. Наконец отметим главный недостаток этой техники -- она абсолютно не совместима с традиционными динамическими моделями и анимациями. Как следствие появляется необходимость использовать совершенно иной подход для рендеринга динамических объектов на сцене, что приводит к сложной логике взаимодействия двух фундаментально разных систем.

\subsubsection{Маскируемые полоски}
Ещё один подход к динамическому уровню детализации представлен в \cite{RIPOLLES2009184}. Модель разбивается на набор полосок из треугольников и на этапе препроцессинга генерируется стратегия схлопывания рёбер внутри этих полосок для достижения нужного уровня детализации. Главным преимуществом этой техники является поддержка сабмешей внутри модели с разным набором вершинных атрибутов. Но в отличии от остальных упомянутых алгоритмов маскируемые полоски очень плохо справляются с низкими уровнями детализации. Алгоритм не подразумевает упрощений между несколькими полосками, из-за чего на дальних дистанциях приходится рендерить сильно больше геометрии чем необходимо. Также расширяемость размера полосок лишь в одном направлении не позволяет сильно увеличить их размер, ведь это привело бы к уменьшению качества картинки. Наконец алгоритму необходимо полностью хранить модель в памяти GPU, что ограничивает его применимость к сильно детализированным моделям.

\subsubsection{Иерархический атлас}
Сравнивая метод представленный в \cite{niski2007multi} с упомянутыми выше, использование иерархического атласа фактически позволяет избавится от всех упомянутых проблем. Путём небольшой модификации алгоритма описанного в \cite{feng2010feature} достигается поддержка скелетных анимаций. Также теоретически не должно возникнуть препятствий в использовании морф-анимаций. Используя модификацию \cite{feng2010feature} размеры карт в атласе могут быть много больше граней каркаса из SSDM, что позволяет лучше адаптировать частоту дискретизации под плотность пикселей на дальних дистанциях. Также в \cite{feng2010feature} предлагается ряд других усовершенствований, позволяющих в сумме добиться десятикратного улучшения качества. Далее, конверсия моделей в формат иерархического атласа полностью автоматизирована и может быть при нужде адаптирована эвристиками под конкретное приложение. К сожалению имплементация самого алгоритма построения иерархического атласа достаточно сложна. Потребление видеопамяти алгоритмом хоть и может быть теоретически ограничено любым значением благодаря виртуализации, но требуемая для достижения фиксированного качества необходимая память растёт квадратично. Однако, в воксельном рейкастинге же память растёт кубически. Наконец самое большое преимущество этой технологии -- независимость выбора частоты дискретизации геометрии, частоты дискретизации текстур, а также фактического количества частей из которого состоит вся поверхность, иначе говоря количества запусков графического конвейера. Заменяя эвристики выбора этих параметров можно адаптировать алгоритм под конкретные данные. Как один из недостатков можно упомянуть что выбор частоты дискретизации хоть и достаточно мелкогранулярен благодаря квадродеревьям, но всё равно проигрывает воксельному рейкастингу где частоту можно независимо выбирать для каждого экранного пикселя. Ещё одним недостатком всех упомянутых схем является применимость их лишь к определённому роду геометрии. Например, использование их с моделью кованого металлического забора с особо сложным рисунком вряд ли даст прирост в производительности или качестве по сравнению с традиционным рендерингом.

Наконец стоит отметить, что при приближении частоты дискретизации модели треугольниками к частоте дискретизации экрана пикселями начинают появляться проблемы алиасинга и "промахивания" треугольников мимо точки семплирования пикселей. В одном из интервью Карис упомянул что для решения этой проблемы при использовании иерархического атласа для создания Nanite (\cite{nanite}) их команде пришлось написать свой программный растеризатор.

\begin{table}[ht]
\small
\centering
\begin{tabular}{ p{24mm} | p{26mm} | p{18mm} | p{20mm} | p{16mm} }
                       & Гранулярность по скринспейсу & Скелетные анимации & Упрощение на высоких дистанциях & Связность \\
\hline
Статические уровни детализации & Нет                          & Да                 & Не ограничено            & Явная     \\
\hline
Иерархический атлас    & Сильная                      & Да                 & Сильное                  & Неявная   \\
\hline
SSDM                   & Средняя                      & Да                 & Слабое                   & Явная     \\
\hline
Воксельный рейкастинг  & Сильная                      & Нет                & Не ограничено            & Неявная   \\
\hline
Маскируемые ленты      & Нет                          & Да                 & Слабое                   & Неявная   \\
\end{tabular}
\caption{Сравнение возможностей рассмотренных подходов}
\end{table}

\begin{table}[ht]
\small
\centering
\begin{tabular}{ p{24mm} | p{24mm} | p{24mm} | p{24mm} | p{24mm} }
                      & Гранулярность по дистанции & Динамическая детализация
                      & Неоднородные атрибуты & Предобработка \\
\hline
Иерархический атлас   & Сильная & Текстуры, геометрия            & Нет & Автоматическая \\
\hline
SSDM                  & Сильная & Геометрия                      & Нет & Ручная \\
\hline
Воксельный рейкастинг & Средняя & Геометрия, топология, текстуры & Нет & Автоматическая \\
\hline
Маскируемые ленты     & Средняя & Геометрия                      & Вершинные & Автоматическая \\
\end{tabular}
\caption{Сравнение возможностей рассмотренных подходов (продолжение)}
\end{table}
